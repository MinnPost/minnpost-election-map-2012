/*! minnpost-election-map-2012 - v0.0.1 - 2016-03-16
* Copyright (c) 2016 ; Licensed  */

window.MinnPost=window.MinnPost||{},function(a,b,c){a.MinnPost.MapView=Backbone.View.extend({options:{dataPath:"./data/",proxyPrefix:"https://mp-jsonproxy.herokuapp.com/proxy?callback=?&url=",mapOptions:{minZoom:3,maxZoom:11},mapID:"map",mapDefaultCenter:new L.LatLng(46.49839225859763,-93.6474609375),mapDefaultZoom:6,mapDefaultLayer:"Minnesota State House Districts",mapMNBounds:[43.499356,-97.239209,49.384358,-89.489226],mapGeocodeURL:"https://open.mapquestapi.com/nominatim/v1/search?format=json&json_callback=?&countrycodes=us&limit=1&q=",applicationSelector:"#minnpost-election-map-2012-application",boundaryURL:"https://boundaries.minnpost.com/1.0/boundary/?sets=state-house-districts-2012,state-senate-districts-2012&callback=?&contains=",translateLayerToBoundary:{"Minnesota State House Districts":"Minnesota State House district","Minnesota State Senate Districts":"Minnesota State Senate district"},translateLayerToDistrict:{"Minnesota State House Districts":"State Representative District ","Minnesota State Senate Districts":"State Senator District "}},candidates:{},mapLayers:{},mapOverlays:{},marker:new L.CircleMarker(new L.LatLng(0,0),{color:"#4A9666",weight:1,opacity:.9,fillColor:"#63B2A7",fillOpacity:.6,radius:8,clickable:!1}),initialize:function(a){this.options=_.extend(this.options,a),this.isIE7()&&(this.options.mapOptions.doubleClickZoom=!1),this.loadCandidates(),this.drawMap(),this.drawSide(),this.drawLayerSwitcher(),this.initAddressSearch()},isIE7:function(){return b.browser.msie&&7==b.browser.version},clearMarker:function(){this.marker!==c&&this.map!==c&&this.map.removeLayer(this.marker)},renderAddressFound:function(){if(this.addressFound===c||_.isEmpty(this.addressFound))return this;var a,d,e,f,g=new L.LatLng(this.addressFound.lat,this.addressFound.lon),h=b(".map-popup-container");this.lastFound="address",this.marker.setLatLng(g),this.map.setView(g,10),this.map.addLayer(this.marker),d=this.options.translateLayerToBoundary[this.currentLayer],e=this.options.translateLayerToDistrict[this.currentLayer];for(a in this.addressFound.boundaries.objects)this.addressFound.boundaries.objects[a].kind==d&&(f=_.template(b("#template-popup-contents").html(),{tileData:{},cands:this.getCandidates(e+this.addressFound.boundaries.objects[a].name),title:e+this.addressFound.boundaries.objects[a].name}),h.html(f),h.fadeIn("fast"));return this},initAddressSearch:function(){var a=this;b("form#search-address-form").submit(function(d){d.preventDefault();var e=b("input#search-address-input").val();if(""!==e)return b(".search-status").removeClass("error").html("Searching..."),b.getJSON(a.options.mapGeocodeURL+encodeURI(e),function(d){var f=a.options.mapMNBounds;d=d[0],d===c?a.showAddressStatus("error","We were unable turn your search terms, "+e+", into a geographical location.  Please be more specific, such as including ZIP code."):d.lat<f[0]||d.lat>f[2]||d.lon<f[1]||d.lon>f[3]?a.showAddressStatus("error","Sorry, but what you are looking for is outside of Minnesota."):b.getJSON(a.options.boundaryURL+encodeURI(d.lat)+","+encodeURI(d.lon),function(e){e.meta.total_count===c||0===e.meta.total_count?a.showAddressStatus("error","Sorry, we were unable to determine the district from that address."):(b(".search-status").fadeOut("fast"),a.addressFound={lat:d.lat,lon:d.lon,boundaries:e},a.clearMarker(),a.renderAddressFound())})}),this})},showAddressStatus:function(a,c){return b(".search-status").html(c),b(".search-status").fadeIn("fast"),"error"==a?b(".search-status").addClass("error"):b(".search-status").removeClass("error"),this},loadCandidates:function(){var a=this,c=this.options.dataPath+"minnesota_registered_candidates.json";return 0===c.indexOf("http")&&(c=this.options.proxyPrefix+encodeURI(c)),b.getJSON(c,function(b){a.candidates=b}),this},getCandidates:function(a){var b=[];return _.isEmpty(this.candidates)||(b=_.filter(this.candidates,function(b){return b.office==a?!0:!1})),b},drawLayerSwitcher:function(){var a=this,d=_.template(b("#template-layer-switcher").html(),{layers:this.mapOverlays,defaultLayer:this.options.mapDefaultLayer});return b(".layer-switcher-container").append(d),b(".layer-switcher-container li a").click(function(d){d.preventDefault();var e,f=b(this).attr("data-id");if(f!=a.currentLayer){a.currentLayer=f,b(".map-popup-container").fadeOut("fast"),b(".layer-switcher-container li a").removeClass("active"),b(this).addClass("active");for(e in a.mapOverlays)e!=f&&a.map.removeLayer(a.mapOverlays[e]);a.map.addLayer(a.mapOverlays[f]),a.lastFound!==c&&"address"==a.lastFound?a.renderAddressFound():a.clearMarker()}}),this},createInteraction:function(a,c){var d=this;a.on("mousemove",function(a){0===a.data.DISTRICT.indexOf("0")&&(a.data.DISTRICT=a.data.DISTRICT.slice(1));var e=d.options.translateLayerToDistrict[c],f=b(".map-popup-container"),g=_.template(b("#template-popup-contents").html(),{tileData:a.data,cands:d.getCandidates(e+a.data.DISTRICT),title:e+a.data.DISTRICT});f.html(g),f.fadeIn("fast")}).on("mouseout",function(a){d.map._container.style.cursor="default"})},drawSide:function(){var a=this.isIE7()?{isIE7:!0}:{isIE7:!1},c=_.template(b("#template-side-column").html(),a);return b(this.options.applicationSelector).append(c),b("#map").css({width:"60%"}),b(".side-column").css({width:"40%","float":"left"}),this.map.invalidateSize(),this},drawMap:function(){var a=this;return this.clickCount=0,this.map=new L.Map(this.options.mapID,this.options.mapOptions),this.addMapLayers(),this.map.setView(this.options.mapDefaultCenter,this.options.mapDefaultZoom),this.map.attributionControl.setPrefix(""),b(".footnote").eq(0).html(b(".footnote").html()+" "+this.map.attributionControl._container.innerHTML),this.map.removeControl(this.map.attributionControl),this.isIE7()||this.map.on("click",function(b){a.clickCount+=1,a.clickCount<=1&&_.delay(function(){a.clickCount<=1&&(a.lastFound="click",a.clearMarker(),a.marker.setLatLng(b.latlng),a.map.addLayer(a.marker)),a.clickCount=0},500)}),this},addMapLayers:function(){var a=this;return this.mapLayers.mapboxBase=L.mapbox.tileLayer("minnpost.map-wi88b700",{attribution:'Some map imagery from <a target="_blank" href="https://mapbox.com">Mapbox</a>'}),this.map.addLayer(this.mapLayers.mapboxBase),this.mapOverlays["Minnesota State House Districts"]=L.mapbox.tileLayer("minnpost.mn-2012-state-leg-leaning"),this.mapOverlays["Minnesota State Senate Districts"]=L.mapbox.tileLayer("minnpost.mn-2012-state-sen-leaning"),a.createInteraction(this.mapOverlays["Minnesota State House Districts"],"Minnesota State House Districts"),a.createInteraction(this.mapOverlays["Minnesota State Senate Districts"],"Minnesota State Senate Districts"),this.map.addLayer(this.mapOverlays["Minnesota State House Districts"]),this.currentLayer=this.mapOverlays["Minnesota State House Districts"],this}})}(window,jQuery);